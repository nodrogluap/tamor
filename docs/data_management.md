# Data Management

Deep whole genome shotgun sequencing and analysis of tumors with matched normals generates a lot of data, 
especially the raw (FASTQ) and genome-aligned reads (BAM) files. Tamor supports several measures to 
reduce the data storage burden.

## Aligned Reads

### Deleting aligned reads

Once variant call (VCF) files are generated, BAM file existence or modification date does *not* triggering Tamor workflow rule reruns. 
Therefore, if you do not want or need the BAMs for subsequent investigations, they can manually removed.

### Compressing aligned reads

Another proactive approach to save disk space is to enable the ``generate_crams`` option in ``config.yaml``, which will cause 
Tamor to output CRAM rather than BAM alignment files during analysis.

Alternatively, the ``workflow/scripts/bam2cram.sh`` script can be used to save space by converting an aligned reads 
BAM file generated by Dragen (or any other aligner) into a lossless, reference-genome-based CRAM file.
This compression typically shrinks the input file to ~35% of its original size.
The standalone script can be run *outside* of Tamor's Snakemake workflow, if samtools>=1.6 is in the shell PATH. 
It takes two arguments:
 - The file path to the existing BAM to be replaced.
 - The FastA-formatted genome to use as a reference (for optimal compatibility with possible Tamor reanalysis, use the same file as specified in Tamor's ``ref_fasta`` setting in ``config.yaml``) 

For example, to compress the completed test case's tumor BAM file:
```bash
workflow/scripts/bam2cram.sh results/PR-TEST-CLL/PR-TEST-CLL-SAMN08512283_PR-TEST-CLL-SAMN08512283-SRR6702602-T_PR-TEST-CLL-SAMN08512283-SRR6702602-N.dna.somatic_tumor.bam resources/GRCh38_full_analysis_set_plus_decoy_hla.fa
```
Tamor will automatically use the CRAM input if found, e.g. for the rule conditionally rerunning germline CNV calling in the case of uneven WGS coverage. 
Otherwise it will fallback to using the BAM if it exists.

Any subsequent processing outside of Tamor will require a copy of the FastA reference used, e.g. with samtools:

```bash
samtools view -T resources/GRCh38_full_analysis_set_plus_decoy_hla.fa results/PR-TEST-CLL/PR-TEST-CLL-SAMN08512283_PR-TEST-CLL-SAMN08512283-SRR6702602-T_PR-TEST-CLL-SAMN08512283-SRR6702602-N.dna.somatic_tumor.cram
```

## Raw reads

### Deleting raw reads

Removal of raw FASTQ or ORA input files will not trigger Tamor workflow rule reruns. 
It is therefore safe to remove these files after VCF file generation. Workflow rerun, including BCL to FASTQ conversion, *will* however be triggered
if the ``results/analysis/primary/sequencer/RunID/Reports/fastq_list.csv`` file is missing or older than the corresponding ``resources/samplesheets/RunID.csv``.

Dragen-generated BAM or CRAM alignment files contain both the mapped and unmapped reads, therefore keeping the FASTQ or ORA input files constitutes a safety net of sorts
since most sequence read information is preserved in the aligned file and could be restored to FASTQ without too much effort. 

It is worth noting that the BCL format of a WGS run is typically ~60% of the size of the equivalent FASTQ.gz files. 
Therefore the BCLs rather than FASTQ.gz files should be kept if there is potential for warranted changes in upstream processing such as  
barcode mismatch allowance, UMI processing, or adapter trimming.

### Compressing raw reads

Unaligned reads used as input to the Tamor workflow can be in standard FASTQ format, or in the proprietary reference-based Illumina ORA-compressed format. 
ORA files are typically ~15% to 20% of the gzip'ed FASTQ file size.
Sequences generated on the NextSeq2000 or NovaSeqX typically have the option of including ORA compression during onboard BCL to FASTQ conversion.

Enabling the ``ora_compress_fastqs`` option in ``config.yaml`` will cause Tamor to replace any FASTQ input files with their ORA-compressed versions after they've been used for alignment/genotyping.

Tamor defaults (``ref_ora`` setting in ``config.yaml``) to downloading and using the [human v2 index reference](https://webdata.illumina.com/downloads/software/dragen/resource-files/misc/lenadata.tar) for compression.
FASTQs can also be converted to ORA files using the standalone script ``workflow/scripts/fastq2ora.sh``, such as for the test case's two FASTQ paired-end read files: 

```bash
workflow/scripts/fastq2ora.sh results/analysis/primary/HiSeq/SRX3676780/SRR6702602_1.fastq.gz  resources/oradata_homo_sapiens
workflow/scripts/fastq2ora.sh results/analysis/primary/HiSeq/SRX3676780/SRR6702602_2.fastq.gz  resources/oradata_homo_sapiens
```

This will require and use Dragen server license for ORA compression.

To use the ORA files in subsequent analyses outside of Tamor and your Dragen server, the 
[free ORA decompresion software](https://support.illumina.com/sequencing/sequencing_software/DRAGENORA.html) 
must be installed and used.
To decompress the ORA data for the test case on any machine (Linux, Mac and Windows are supported):

```bash
orad --ora-reference reference/oradata_homo_sapiens --path your_desired_outdir_name results/analysis/primary/HiSeq/SRX3676780/SRR6702602_1.fastq.ora
orad --ora-reference reference/oradata_homo_sapiens --path your_desired_outdir_name results/analysis/primary/HiSeq/SRX3676780/SRR6702602_2.fastq.ora
```
